import React, { useState, useEffect, useRef } from 'react';

export default function StudyTimer() {
  const [timeLeft, setTimeLeft] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [currentQuote, setCurrentQuote] = useState(0);
  const [points, setPoints] = useState(0);
  const [studySessions, setStudySessions] = useState([]);
  const [showSubjectModal, setShowSubjectModal] = useState(false);
  const [showShop, setShowShop] = useState(false);
  const [subject, setSubject] = useState('');
  const [completedTime, setCompletedTime] = useState(0);
  const [lastQuoteTime, setLastQuoteTime] = useState(0);
  
  const quotes = [
    { text: "ì²œì¬ëŠ” 1%ì˜ ì˜ê°ê³¼ 99%ì˜ ë…¸ë ¥ì´ë‹¤", author: "í† ë§ˆìŠ¤ ì—ë””ìŠ¨" },
    { text: "ë°°ì›€ì—ëŠ” ì™•ë„ê°€ ì—†ë‹¤", author: "ìœ í´ë¦¬ë“œ" },
    { text: "ì‹¤íŒ¨ëŠ” ì„±ê³µì˜ ì–´ë¨¸ë‹ˆë‹¤", author: "í† ë§ˆìŠ¤ ì—ë””ìŠ¨" },
    { text: "ì•„ëŠ” ê²ƒì´ í˜ì´ë‹¤", author: "í”„ëœì‹œìŠ¤ ë² ì´ì»¨" },
    { text: "ì²œì²œíˆ ì„œë‘ë¥´ë¼", author: "ê³µì" },
    { text: "ì‹œì‘ì´ ë°˜ì´ë‹¤", author: "ì•„ë¦¬ìŠ¤í† í…”ë ˆìŠ¤" },
    { text: "ë…¸ë ¥ì€ ë°°ì‹ í•˜ì§€ ì•ŠëŠ”ë‹¤", author: "ì´ì†Œë£¡" },
    { text: "ê¿ˆì„ ê³„ì† ê°„ì§í•˜ê³  ìˆìœ¼ë©´ ë°˜ë“œì‹œ ì‹¤í˜„í•  ë•Œê°€ ì˜¨ë‹¤", author: "ê´´í…Œ" },
    { text: "í•˜ë£¨í•˜ë£¨ë¥¼ ì¸ìƒì˜ ë§ˆì§€ë§‰ ë‚ ì²˜ëŸ¼ ì‚´ì•„ë¼", author: "ìŠ¤í‹°ë¸Œ ì¡ìŠ¤" },
    { text: "ë…¸ë ¥ ì—†ì´ëŠ” ì•„ë¬´ê²ƒë„ ì–»ì„ ìˆ˜ ì—†ë‹¤", author: "ì•Œë² ë¥´íŠ¸ ì•„ì¸ìŠˆíƒ€ì¸" }
  ];

  const shopItems = [
    { points: 2, breakTime: 10 },
    { points: 4, breakTime: 20 },
    { points: 6, breakTime: 30 },
    { points: 8, breakTime: 40 },
    { points: 10, breakTime: 50 },
    { points: 12, breakTime: 60 }
  ];

  useEffect(() => {
    let interval;
    if (isRunning && timeLeft > 0) {
      interval = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            setIsRunning(false);
            setCompletedTime(timeLeft);
            setShowSubjectModal(true);
            return 0;
          }
          
          // 5ë¶„ë§ˆë‹¤ ëª…ì–¸ ë³€ê²½
          const newTime = prev - 1;
          if (Math.floor(newTime / 60) % 5 === 0 && newTime % 60 === 0 && newTime !== lastQuoteTime) {
            setLastQuoteTime(newTime);
            setCurrentQuote((prevQuote) => (prevQuote + 1) % quotes.length);
          }
          
          return newTime;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isRunning, timeLeft]);

  const addTime = (minutes) => {
    setTimeLeft(prev => prev + minutes * 60);
    if (!isRunning) {
      setIsRunning(true);
    }
  };

  const formatTime = (seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  const handleSubjectSubmit = () => {
    if (subject.trim()) {
      const earnedPoints = Math.floor(completedTime / 1800); // 30ë¶„ë‹¹ 1í¬ì¸íŠ¸
      setPoints(prev => prev + earnedPoints);
      setStudySessions(prev => [...prev, {
        subject: subject.trim(),
        time: completedTime,
        points: earnedPoints,
        date: new Date().toLocaleString('ko-KR')
      }]);
      setSubject('');
      setShowSubjectModal(false);
    }
  };

  const purchaseBreak = (item) => {
    if (points >= item.points) {
      setPoints(prev => prev - item.points);
      alert(`${item.breakTime}ë¶„ íœ´ì‹ ì‹œì‘! ğŸ®`);
      // íœ´ì‹ íƒ€ì´ë¨¸ ì‹œì‘
      setTimeLeft(item.breakTime * 60);
      setIsRunning(true);
      setShowShop(false);
    }
  };

  return (
    <div className="min-h-screen bg-black text-green-400 font-mono p-8 relative overflow-hidden">
      {/* ì‚¬ì´ë²„í‘í¬ ë°°ê²½ íš¨ê³¼ */}
      <div className="absolute inset-0 opacity-10">
        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent animate-pulse"></div>
        <div className="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent animate-pulse"></div>
      </div>

      <div className="max-w-4xl mx-auto relative z-10">
        {/* íƒ€ì´í‹€ */}
        <h1 className="text-5xl font-bold text-center mb-12 tracking-wider relative">
          <span className="text-green-400 drop-shadow-[0_0_10px_rgba(34,197,94,0.8)]">
            ê³µë¶€ íƒ€ì´ë¨¸
          </span>
          <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-64 h-1 bg-gradient-to-r from-transparent via-green-400 to-transparent"></div>
        </h1>

        {/* í¬ì¸íŠ¸ í‘œì‹œ */}
        <div className="text-right mb-4">
          <button 
            onClick={() => setShowShop(!showShop)}
            className="px-6 py-2 border-2 border-green-400 hover:bg-green-400 hover:text-black transition-all duration-300 shadow-[0_0_10px_rgba(34,197,94,0.5)]"
          >
            ğŸ’ í¬ì¸íŠ¸: {points}P
          </button>
        </div>

        {/* ëª…ì–¸ */}
        <div className="mb-12 p-6 border-2 border-green-400 bg-black/50 shadow-[0_0_20px_rgba(34,197,94,0.3)] backdrop-blur-sm">
          <p className="text-xl mb-2 text-center italic">"{quotes[currentQuote].text}"</p>
          <p className="text-right text-green-300">- {quotes[currentQuote].author}</p>
        </div>

        {/* íƒ€ì´ë¨¸ ë””ìŠ¤í”Œë ˆì´ */}
        <div className="mb-12 text-center">
          <div className="text-8xl font-bold mb-8 tracking-widest drop-shadow-[0_0_20px_rgba(34,197,94,0.8)]">
            {formatTime(timeLeft)}
          </div>
          
          {/* ì‹œê°„ ì¶”ê°€ ë²„íŠ¼ */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            {[30, 60, 90, 120].map(min => (
              <button
                key={min}
                onClick={() => addTime(min)}
                className="py-4 px-6 border-2 border-green-400 hover:bg-green-400 hover:text-black transition-all duration-300 text-2xl font-bold shadow-[0_0_15px_rgba(34,197,94,0.5)] hover:shadow-[0_0_25px_rgba(34,197,94,0.8)]"
              >
                +{min}ë¶„
              </button>
            ))}
          </div>

          {/* ì‹œì‘/ì •ì§€ ë²„íŠ¼ */}
          <button
            onClick={() => setIsRunning(!isRunning)}
            disabled={timeLeft === 0}
            className={`px-12 py-4 text-2xl font-bold border-2 transition-all duration-300 ${
              timeLeft === 0 
                ? 'border-gray-600 text-gray-600 cursor-not-allowed' 
                : 'border-green-400 hover:bg-green-400 hover:text-black shadow-[0_0_15px_rgba(34,197,94,0.5)]'
            }`}
          >
            {isRunning ? 'ì¼ì‹œì •ì§€' : 'ì‹œì‘'}
          </button>
        </div>

        {/* ìƒì  ëª¨ë‹¬ */}
        {showShop && (
          <div className="mb-8 p-6 border-2 border-green-400 bg-black/90 shadow-[0_0_30px_rgba(34,197,94,0.5)]">
            <h2 className="text-3xl font-bold mb-6 text-center">ğŸ® íœ´ì‹ ìƒì </h2>
            <div className="grid grid-cols-2 gap-4">
              {shopItems.map(item => (
                <button
                  key={item.points}
                  onClick={() => purchaseBreak(item)}
                  disabled={points < item.points}
                  className={`p-4 border-2 transition-all duration-300 ${
                    points >= item.points
                      ? 'border-green-400 hover:bg-green-400 hover:text-black shadow-[0_0_10px_rgba(34,197,94,0.5)]'
                      : 'border-gray-600 text-gray-600 cursor-not-allowed'
                  }`}
                >
                  <div className="text-xl font-bold">{item.breakTime}ë¶„ íœ´ì‹</div>
                  <div className="text-sm">{item.points}P</div>
                </button>
              ))}
            </div>
            <button 
              onClick={() => setShowShop(false)}
              className="mt-4 w-full py-2 border border-green-400 hover:bg-green-400 hover:text-black transition-all duration-300"
            >
              ë‹«ê¸°
            </button>
          </div>
        )}

        {/* ê³¼ëª© ì…ë ¥ ëª¨ë‹¬ */}
        {showSubjectModal && (
          <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
            <div className="bg-black border-4 border-green-400 p-8 max-w-md w-full shadow-[0_0_40px_rgba(34,197,94,0.8)]">
              <h2 className="text-3xl font-bold mb-6 text-center">ê³µë¶€ ì™„ë£Œ! ğŸ‰</h2>
              <p className="mb-4 text-center text-xl">
                {Math.floor(completedTime / 60)}ë¶„ ê³µë¶€í•˜ì…¨ìŠµë‹ˆë‹¤!
              </p>
              <p className="mb-6 text-center text-2xl font-bold">
                íšë“ í¬ì¸íŠ¸: {Math.floor(completedTime / 1800)}P ğŸ’
              </p>
              <input
                type="text"
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                placeholder="ì–´ë–¤ ê³¼ëª©ì„ ê³µë¶€í–ˆë‚˜ìš”?"
                className="w-full p-3 mb-4 bg-black border-2 border-green-400 text-green-400 placeholder-green-700 focus:outline-none focus:shadow-[0_0_15px_rgba(34,197,94,0.5)]"
                onKeyPress={(e) => e.key === 'Enter' && handleSubjectSubmit()}
              />
              <button
                onClick={handleSubjectSubmit}
                className="w-full py-3 border-2 border-green-400 hover:bg-green-400 hover:text-black transition-all duration-300 font-bold text-xl shadow-[0_0_10px_rgba(34,197,94,0.5)]"
              >
                ê¸°ë¡í•˜ê¸°
              </button>
            </div>
          </div>
        )}

        {/* ê³µë¶€ ê¸°ë¡ */}
        {studySessions.length > 0 && (
          <div className="mt-12 p-6 border-2 border-green-400 bg-black/50 shadow-[0_0_20px_rgba(34,197,94,0.3)]">
            <h2 className="text-3xl font-bold mb-6 text-center">ğŸ“Š ê³µë¶€ ê¸°ë¡</h2>
            <div className="space-y-3">
              {studySessions.slice().reverse().map((session, idx) => (
                <div key={idx} className="p-4 border border-green-400/50 hover:border-green-400 transition-all duration-300 hover:shadow-[0_0_10px_rgba(34,197,94,0.3)]">
                  <div className="flex justify-between items-center">
                    <span className="text-xl font-bold">{session.subject}</span>
                    <span className="text-lg">{Math.floor(session.time / 60)}ë¶„ (+{session.points}P)</span>
                  </div>
                  <div className="text-sm text-green-300 mt-1">{session.date}</div>
                </div>
              ))}
            </div>
            <div className="mt-6 text-center text-xl font-bold">
              ì´ ê³µë¶€ ì‹œê°„: {Math.floor(studySessions.reduce((sum, s) => sum + s.time, 0) / 60)}ë¶„
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
